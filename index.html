<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raspadito System v39 (Ultimate Merge)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- ESTILOS VISUALES RESTAURADOS (v32) --- */
        * { -webkit-user-select: none; -moz-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        input, textarea { user-select: text !important; -webkit-user-select: text !important; }
        
        body { 
            background-color: #f0f2f5; position: fixed; top:0; left:0; right:0; bottom:0;
            overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none;
        }
        
        .navbar-custom { height: 50px; background-color: #212529; flex-shrink: 0; z-index: 1030; }
        .main-container { height: calc(100% - 50px); margin-top: 50px; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Paneles y Scroll */
        .seccion-app { display: none; width: 100%; height: 100%; overflow-y: auto; padding-bottom: 100px; touch-action: pan-y; }
        #vista-pos.seccion-app { padding-bottom: 0 !important; display: none; flex-direction: column; overflow: hidden; }
        .seccion-activa { display: block !important; }
        #vista-pos.seccion-activa { display: flex !important; }

        .pos-split-container { display: flex; flex-grow: 1; overflow: hidden; height: 100%; position: relative; }
        .panel-productos { flex-grow: 1; overflow-y: auto; padding: 10px; background-color: #e9ecef; min-width: 150px; touch-action: pan-y; }
        
        /* Grid Inteligente */
        #grid-productos-pos { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 8px; width: 100%; }

        /* Resizers */
        .resizer-h { width: 30px; margin-left: -15px; margin-right: -15px; position: relative; z-index: 100; cursor: col-resize; display: flex; justify-content: center; align-items: center; touch-action: none; background: transparent; }
        .resizer-h::before { content: ""; position: absolute; left: 14px; top:0; bottom:0; width: 2px; background: #ccc; pointer-events: none; }
        .resizer-h::after { content: ""; display: block; width: 6px; height: 30px; background: #e0e0e0; border: 1px solid #999; border-radius: 3px; position: relative; pointer-events: none; }
        .resizer-locked { cursor: default !important; opacity: 0.5; pointer-events: none; }

        .panel-ticket { width: 350px; min-width: 200px; background: white; display: flex; flex-direction: column; height: 100%; border-left: 1px solid #ccc; z-index: 90; }
        .ticket-lista { flex-grow: 1; overflow-y: auto; background: #fff; padding: 5px; touch-action: pan-y; }
        .area-totales { background: #f8f9fa; border-top: 1px solid #dee2e6; padding: 15px; flex-shrink: 0; }
        
        /* Botones Producto */
        .btn-producto { height: 100px; width: 100%; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: transform 0.1s; position: relative; z-index: 1; touch-action: manipulation; }
        .btn-producto:active { transform: scale(0.95); }
        .btn-producto span.small { font-size: 0.8rem; line-height: 1.1; text-align: center; margin-bottom: 4px; padding: 0 4px; }
        .qty-badge { position: absolute; top: -8px; right: -8px; background-color: #dc3545; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10; border: 2px solid #e9ecef; }

        /* Teclado Flotante PC */
        #floating-keypad { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 480px; background: rgba(255, 255, 255, 0.98); border: 1px solid #ccc; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); display: flex; flex-direction: column; z-index: 1040; backdrop-filter: blur(8px); min-width: 200px; min-height: 40px; container-type: size; touch-action: none; }
        #keypad-header { height: 40px; background: #212529; color: white; border-radius: 15px 15px 0 0; cursor: move; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; letter-spacing: 1px; touch-action: none; }
        #keypad-body { flex-grow: 1; padding: 2cqh; display: flex; flex-direction: column; gap: 1cqh; }
        .screen-keypad { text-align: right; background: #f8f9fa; padding: 1.5cqh; border-radius: 12px; border: 1px solid #e9ecef; display: flex; flex-direction: column; justify-content: flex-end; height: 22%; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        .screen-input { font-size: 8cqh; font-weight: bold; color: #212529; line-height: 1; flex-grow: 1; display: flex; align-items: flex-end; justify-content: flex-end; margin-bottom: 0.5cqh; }
        .screen-info { font-size: 3.5cqh; display: flex; justify-content: space-between; border-top: 1px solid #e0e0e0; padding-top: 0.8cqh; color: #6c757d; }
        .teclado-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1cqh; flex-grow: 1; }
        .teclado-btn { width: 100%; height: 100%; font-size: 5cqh; font-weight: bold; border-radius: 10px; border: 1px solid #ced4da; background-color: white; display: flex; align-items: center; justify-content: center; padding: 0; transition: background 0.1s; }
        .teclado-btn:active { background-color: #e2e6ea; }
        #btn-cobrar-key { font-size: 5cqh; height: 15%; border-radius: 10px; }
        #resize-handle { width: 15px; height: 15px; position: absolute; bottom: 5px; right: 5px; cursor: nwse-resize; z-index: 10; touch-action: none; opacity: 0.5; background: repeating-linear-gradient(135deg, transparent, transparent 4px, #6c757d 4px, #6c757d 5px, transparent 5px, transparent 8px); }

        /* Login Card */
        #loader-overlay, #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #212529; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #loader-overlay { background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); }
        .login-card { width: 90%; max-width: 350px; background: white; padding: 30px; border-radius: 15px; text-align: center; }
        .hidden-worker { display: none !important; }

        /* --- ANIMACIONES DE REPORTES (RESTAURADAS) --- */
        .cursor-pointer { cursor: pointer; }
        .fila-detalle { display: none; background-color: #f8f9fa; } 
        .fila-activa { display: table-row !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Mobile Tabs */
        .mobile-tabs-container { display: none; position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 2000; padding-bottom: 5px; }
        .tab-btn { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.85rem; color: #6c757d; border: none; background: none; padding: 5px; }
        .tab-btn.active { color: #0d6efd; font-weight: bold; background-color: #f8f9fa; }
        .tab-btn i { font-size: 1.4rem; margin-bottom: 4px; }
        .tab-badge { background: #198754; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px; }

        @media (max-width: 768px) {
            .mobile-tabs-container { display: flex; }
            .pos-split-container { display: block; }
            .resizer-h { display: none !important; }
            .panel-productos, .panel-ticket { width: 100% !important; height: calc(100% - 65px) !important; display: none; padding-bottom: 0; }
            .show-mobile { display: block !important; }
            .show-mobile-flex { display: flex !important; }
            #panel-ticket.show-mobile-flex { flex-direction: column; justify-content: space-between; background-color: #f8f9fa; }
            #ticket-lista { flex-grow: 1; height: 40%; overflow-y: auto; border-bottom: 1px solid #ccc; }
            .area-totales { display: none !important; }
            #floating-keypad { position: relative !important; width: 100% !important; height: 55% !important; left: auto !important; bottom: auto !important; right: auto !important; top: auto !important; border-radius: 0 !important; box-shadow: none !important; border: none; border-top: 1px solid #ccc; z-index: 1; }
            #keypad-header, #resize-handle { display: none; }
            #keypad-body { padding: 5px; }
            .screen-keypad { height: 18%; padding: 5px; } .screen-input { font-size: 2rem; margin: 0; } .teclado-btn { font-size: 1.5rem; }
            .keypad-hidden-mobile { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="text-white mb-4 text-center">
            <h1><i class="fa-solid fa-store"></i> Raspadito</h1>
            <p>Acceso Seguro</p>
        </div>
        <div class="login-card shadow">
            <div class="mb-3 text-start">
                <label class="form-label small text-muted fw-bold">Correo</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="fa-solid fa-envelope text-secondary"></i></span>
                    <input type="email" id="login-email" class="form-control" placeholder="usuario@raspadito.com">
                </div>
            </div>
            
            <div class="mb-4 text-start">
                <label class="form-label small text-muted fw-bold">Contraseña</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="fa-solid fa-lock text-secondary"></i></span>
                    <input type="password" id="login-password" class="form-control" placeholder="••••••">
                </div>
            </div>

            <button class="btn btn-primary w-100 btn-lg fw-bold" onclick="checkLogin()">
                INICIAR SESIÓN
            </button>
            
            <p class="text-danger mt-3 mb-0 small fw-bold" id="login-error" style="display:none;"></p>
        </div>
        <p class="text-white-50 mt-4 small" id="login-status">v39.0 Ultimate Merge</p>
    </div>

    <div id="loader-overlay" style="display:none;">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-2 fw-bold text-secondary">Cargando...</p>
        </div>
    </div>

    <nav class="navbar navbar-dark navbar-custom px-3 fixed-top">
        <button class="btn btn-sm btn-outline-light border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral">
            <i class="fa-solid fa-bars fa-lg"></i> <span class="ms-2 fw-bold">MENÚ</span>
        </button>
        <span class="text-white fw-bold small" id="titulo-vista">Punto de Venta</span>
        <div class="ms-auto d-flex align-items-center">
            <span id="role-badge" class="badge bg-danger me-2">...</span>
            <button class="btn btn-sm btn-outline-warning" id="btn-lock-layout" onclick="toggleLayoutLock()" title="Fijar Diseño">
                <i class="fa-solid fa-lock-open"></i>
            </button>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="menuLateral">
        <div class="offcanvas-header border-bottom border-secondary">
            <h5 class="offcanvas-title">Raspadito System</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action bg-dark text-white p-3" onclick="navegar('pos')"><i class="fa-solid fa-cash-register me-2"></i> Punto de Venta</button>
            <button class="list-group-item list-group-item-action bg-dark text-white p-3 restricted" onclick="navegar('productos')"><i class="fa-solid fa-tags me-2"></i> Inventario</button>
            <button class="list-group-item list-group-item-action bg-dark text-white p-3 restricted" onclick="navegar('diarias')"><i class="fa-solid fa-chart-column me-2"></i> Reporte Diario</button>
            <button class="list-group-item list-group-item-action bg-dark text-white p-3 restricted" onclick="navegar('especificas')"><i class="fa-solid fa-calendar-day me-2"></i> Ventas Específicas</button>
            <button class="list-group-item list-group-item-action bg-dark text-white p-3 restricted" onclick="navegar('generales')"><i class="fa-solid fa-calendar-days me-2"></i> Historial General</button>
            <button class="list-group-item list-group-item-action bg-dark text-white p-3 restricted" onclick="navegar('exportar')"><i class="fa-solid fa-file-excel me-2"></i> Exportar</button>
            <button class="list-group-item list-group-item-action bg-dark text-danger p-3 mt-5 border-top border-secondary" onclick="cerrarSesion()"><i class="fa-solid fa-right-from-bracket me-2"></i> Cerrar Sesión</button>
        </div>
    </div>

    <div class="container-fluid p-0 main-container" id="main-container">
        <div id="vista-pos" class="seccion-app seccion-activa">
            <div class="pos-split-container">
                <div class="panel-productos show-mobile" id="panel-productos"><div id="grid-productos-pos"></div></div>
                <div class="resizer-h" id="resizer-h"></div>
                <div class="panel-ticket" id="panel-ticket">
                    <div class="bg-secondary text-white px-3 py-2 d-flex justify-content-between"><span>Ticket</span> <span class="badge bg-light text-dark" id="items-count">0</span></div>
                    <div id="ticket-lista" class="ticket-lista"><div class="text-center text-muted mt-5 small">Vacío</div></div>
                    <div class="area-totales">
                        <div class="d-flex justify-content-between h3 fw-bold"><span>Total:</span> <span id="txt-total">$0</span></div>
                        <div class="d-flex justify-content-between small text-muted"><span id="txt-recibido-main">Recibido: -</span><span id="txt-cambio-main">Cambio: $0</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mobile-tabs-container">
            <button class="tab-btn active" id="tab-prod" onclick="switchMobileTab('prod')"><i class="fa-solid fa-utensils"></i> Menú</button>
            <button class="tab-btn" id="tab-ticket" onclick="switchMobileTab('ticket')"><div class="d-flex align-items-center"><i class="fa-solid fa-receipt me-1"></i> <span>Cobrar</span><span id="tab-total-badge" class="tab-badge">$0</span></div></button>
        </div>
        <div id="vista-productos" class="seccion-app container py-3"><div class="d-flex justify-content-between align-items-center mb-3"><h4>Inventario</h4><button class="btn btn-primary btn-sm" onclick="abrirModalProducto()">+ Nuevo</button></div><div class="table-responsive bg-white shadow-sm rounded"><table class="table table-hover mb-0 align-middle"><tbody id="tabla-productos-body"></tbody></table></div></div>
        
        <div id="vista-diarias" class="seccion-app container py-3">
            <div class="row mb-3"><div class="col-6"><div class="card bg-primary text-white p-3 shadow-sm h-100"><h6 class="small opacity-75">Venta Hoy</h6><h3 class="fw-bold mb-0" id="reporte-total-hoy">$0</h3></div></div><div class="col-6"><div class="card bg-white border p-3 shadow-sm h-100"><h6 class="small text-muted">Transacciones</h6><h3 class="fw-bold mb-0" id="reporte-conteo-hoy">0</h3></div></div></div>
            <div class="card shadow-sm mb-4"><div class="card-header bg-white small fw-bold">Ventas por Hora</div><div class="card-body" style="height:250px"><canvas id="graficoDia"></canvas></div></div>
            <h5 class="mb-2">Tickets de Hoy</h5>
            <div class="card shadow-sm"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover mb-0"><tbody id="tbody-ventas-hoy"></tbody></table></div></div></div>
        </div>

        <div id="vista-especificas" class="seccion-app container py-3"><div class="card p-3 mb-4 bg-light shadow-sm border-0"><label class="fw-bold small mb-2">Seleccionar Día:</label><div class="input-group"><input type="date" id="filtro-dia-especifico" class="form-control"><button class="btn btn-primary fw-bold" onclick="cargarVentasEspecificas()">VER REPORTE</button></div></div><div id="contenido-especifico" style="display:none;"><div class="d-flex justify-content-between align-items-center mb-3"><h4 class="mb-0 fw-bold" id="titulo-dia-esp">Resumen</h4><span class="badge bg-success fs-5" id="total-dia-esp">$0</span></div><div class="card shadow-sm mb-4"><div class="card-header bg-white small fw-bold">Actividad por Hora</div><div class="card-body" style="height:250px;"><canvas id="graficoEspecifico"></canvas></div></div><h5 class="mb-2">Ranking de Productos</h5><div class="card shadow-sm mb-4"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>Producto</th><th class="text-center">Cant</th><th class="text-end">Total</th></tr></thead><tbody id="tabla-productos-esp"></tbody></table></div></div></div></div>
        
        <div id="vista-generales" class="seccion-app container py-3">
             <div class="card p-3 mb-3 bg-light shadow-sm"><label class="fw-bold small mb-2">Filtrar Fechas:</label><div class="input-group"><input type="date" id="filtro-inicio" class="form-control"><input type="date" id="filtro-fin" class="form-control"><button class="btn btn-primary" onclick="cargarReporteGeneral()">Ver</button></div></div>
             <div id="contenedor-historial"><p class="text-muted text-center mt-4">Selecciona fechas.</p></div>
        </div>
        
        <div id="vista-exportar" class="seccion-app container py-5 text-center"><i class="fa-solid fa-file-excel fa-4x text-success mb-3"></i><h3>Exportar Excel</h3><div class="card p-4 mx-auto mt-3 shadow-sm" style="max-width:400px"><div class="mb-2 text-start"><label class="small fw-bold">Desde</label><input type="date" id="exp-inicio" class="form-control"></div><div class="mb-3 text-start"><label class="small fw-bold">Hasta</label><input type="date" id="exp-fin" class="form-control"></div><button class="btn btn-success w-100 fw-bold" onclick="descargarExcel()">DESCARGAR</button></div></div>
    </div>

    <div id="floating-keypad">
        <div id="keypad-header">Teclado</div>
        <div id="keypad-body">
            <div class="screen-keypad"><div class="screen-input text-primary" id="keypad-input">-</div><div class="screen-info"><span id="keypad-total-info" class="text-muted fw-bold" style="opacity:0.7">$0</span><span class="fw-bold" id="keypad-cambio-info">Cambio: $0</span></div></div>
            <div class="teclado-grid"><button class="teclado-btn" onclick="teclado(7)">7</button><button class="teclado-btn" onclick="teclado(8)">8</button><button class="teclado-btn" onclick="teclado(9)">9</button><button class="teclado-btn" onclick="teclado(4)">4</button><button class="teclado-btn" onclick="teclado(5)">5</button><button class="teclado-btn" onclick="teclado(6)">6</button><button class="teclado-btn" onclick="teclado(1)">1</button><button class="teclado-btn" onclick="teclado(2)">2</button><button class="teclado-btn" onclick="teclado(3)">3</button><button class="teclado-btn text-danger" onclick="borrarInput()"><i class="fa-solid fa-delete-left"></i></button><button class="teclado-btn" onclick="teclado(0)">0</button><button class="teclado-btn btn-warning text-white" onclick="limpiarTicket()"><i class="fa-solid fa-trash"></i></button></div>
            <button id="btn-cobrar-key" class="btn btn-success w-100 fw-bold shadow-sm" onclick="cobrar()">COBRAR</button>
        </div>
        <div id="resize-handle"></div>
    </div>

    <div class="modal fade" id="modalProducto" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-body"><input type="hidden" id="prod-id"><label class="small">Nombre</label><input type="text" class="form-control mb-2" id="prod-nombre"><label class="small">Precio</label><input type="number" class="form-control mb-2" id="prod-precio"><label class="small">Color</label><input type="color" class="form-control mb-2" id="prod-color" style="height:40px"><div class="d-flex mt-3"><button class="btn btn-danger btn-sm me-auto" onclick="eliminarProducto()" id="btn-del-prod">Borrar</button><button class="btn btn-primary btn-sm" onclick="guardarProducto()">Guardar</button></div></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        document.addEventListener('contextmenu', event => event.preventDefault());
        
        const firebaseConfig = {
            apiKey: "AIzaSyCtYiB82SKyGGbjeh8iZCzSefkC5H1_NTs",
            authDomain: "pdv-raspaditomx.firebaseapp.com",
            projectId: "pdv-raspaditomx",
            storageBucket: "pdv-raspaditomx.firebasestorage.app",
            messagingSenderId: "110249134810",
            appId: "1:110249134810:web:66f1765db51b9f3d8b73e3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- CONFIGURACIÓN DE ROLES ---
        const ADMIN_EMAILS = [
            'admin@raspadito.com', 
            'raspaditomx@gmail.com'
        ];

        window.currentRole = null;
        let unsubscribeProd = null;
        let unsubscribeVentas = null;

        const lastEmail = localStorage.getItem('lastEmail');
        if(lastEmail) document.getElementById('login-email').value = lastEmail;

        window.checkLogin = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const statusLabel = document.getElementById('login-status');
            const errorLabel = document.getElementById('login-error');
            
            if(!email || !password) return;

            statusLabel.innerText = "Verificando...";
            errorLabel.style.display = 'none';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                localStorage.setItem('lastEmail', email);
            } catch (error) {
                console.error(error);
                statusLabel.innerText = "Error";
                errorLabel.innerText = "Datos incorrectos";
                errorLabel.style.display = 'block';
            }
        };

        document.getElementById('login-password').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') window.checkLogin();
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                if(ADMIN_EMAILS.includes(user.email)) {
                    window.currentRole = 'admin';
                } else {
                    window.currentRole = 'worker';
                }
                aplicarPermisos(window.currentRole);
                navegar('pos');
                iniciarEscuchas();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                window.currentRole = null;
                document.getElementById('login-password').value = '';
                detenerEscuchas();
            }
        });

        function iniciarEscuchas() {
            if(!unsubscribeProd) {
                const qProd = query(collection(db, "productos"), orderBy("orden", "asc"));
                unsubscribeProd = onSnapshot(qProd, (snapshot) => {
                    window.productos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    window.cargarTablaProductos(); window.renderizarPOS();
                    document.getElementById('loader-overlay').style.display = 'none';
                }, (error) => { console.error("Error productos:", error); });
            }
            if(!unsubscribeVentas) {
                const qVentas = query(collection(db, "ventas"));
                unsubscribeVentas = onSnapshot(qVentas, (snapshot) => {
                    window.ventas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(document.getElementById('vista-diarias').classList.contains('seccion-activa')) window.cargarReporteDiario();
                    if(document.getElementById('vista-generales').classList.contains('seccion-activa')) window.cargarReporteGeneral();
                    if(document.getElementById('vista-especificas').classList.contains('seccion-activa')) window.cargarVentasEspecificas();
                }, (error) => { console.error("Error ventas:", error); });
            }
        }

        function detenerEscuchas() {
            if(unsubscribeProd) { unsubscribeProd(); unsubscribeProd = null; }
            if(unsubscribeVentas) { unsubscribeVentas(); unsubscribeVentas = null; }
            window.productos = []; window.ventas = [];
        }

        window.cerrarSesion = () => {
            window.carrito = []; window.montoRecibido = ""; window.actualizarTicket();
            signOut(auth).then(() => { location.reload(); });
        };

        function aplicarPermisos(role) {
            const badge = document.getElementById('role-badge');
            const restrictedItems = document.querySelectorAll('.restricted');
            if(role === 'admin') {
                badge.className = 'badge bg-danger me-2'; badge.innerText = 'ADMIN';
                restrictedItems.forEach(el => el.classList.remove('hidden-worker'));
            } else {
                badge.className = 'badge bg-success me-2'; badge.innerText = 'VENTA';
                restrictedItems.forEach(el => el.classList.add('hidden-worker'));
            }
        }

        window.switchMobileTab = (tab) => {
            const pProd = document.getElementById('panel-productos');
            const pTicket = document.getElementById('panel-ticket');
            const btnProd = document.getElementById('tab-prod');
            const btnTicket = document.getElementById('tab-ticket');
            const keypad = document.getElementById('floating-keypad');

            if(tab === 'prod') {
                pProd.classList.add('show-mobile');
                pTicket.classList.remove('show-mobile-flex');
                btnProd.classList.add('active');
                btnTicket.classList.remove('active');
                keypad.classList.add('keypad-hidden-mobile');
            } else {
                pProd.classList.remove('show-mobile');
                pTicket.classList.add('show-mobile-flex');
                btnProd.classList.remove('active');
                btnTicket.classList.add('active');
                if(window.innerWidth <= 768) { pTicket.appendChild(keypad); keypad.classList.remove('keypad-hidden-mobile'); }
            }
        };
        window.switchMobileTab('prod');

        window.productos = []; window.ventas = []; window.carrito = []; window.montoRecibido = "";
        window.chartDia = null; window.chartEsp = null; window.editId = null; window.isLayoutLocked = false;

        window.fechaLocalCorta = (isoString) => { if(!isoString) return ""; const fecha = new Date(isoString); const year = fecha.getFullYear(); const month = String(fecha.getMonth() + 1).padStart(2, '0'); const day = String(fecha.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
        window.getContrastYIQ = (hex) => { hex = hex.replace("#", ""); var r = parseInt(hex.substr(0,2),16); var g = parseInt(hex.substr(2,2),16); var b = parseInt(hex.substr(4,2),16); return (((r*299)+(g*587)+(b*114))/1000) >= 128 ? 'black' : 'white'; };
        
        window.navegar = (vista) => {
            if(window.currentRole === 'worker' && vista !== 'pos') return alert("Acceso restringido a Vendedores");
            document.querySelectorAll('.seccion-app').forEach(s => s.classList.remove('seccion-activa'));
            document.getElementById('vista-' + vista).classList.add('seccion-activa');
            const offcanvas = document.getElementById('menuLateral');
            const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvas);
            if(bsOffcanvas) bsOffcanvas.hide();
            const titulos = { 'pos': 'Punto de Venta', 'productos': 'Inventario', 'diarias': 'Reporte Diario', 'especificas': 'Ventas Específicas', 'generales': 'Historial', 'exportar': 'Descargas' };
            document.getElementById('titulo-vista').innerText = titulos[vista];
            const keypad = document.getElementById('floating-keypad');
            const mobileTabs = document.querySelector('.mobile-tabs-container');
            if (vista === 'pos') { keypad.style.display = 'flex'; document.body.appendChild(keypad); window.switchMobileTab('prod'); if(window.innerWidth <= 768) mobileTabs.style.display = 'flex'; } else { keypad.style.display = 'none'; mobileTabs.style.display = 'none'; }
            if(vista === 'productos') window.cargarTablaProductos();
            if(vista === 'diarias') window.cargarReporteDiario();
        };

        window.toggleLayoutLock = () => { window.isLayoutLocked = !window.isLayoutLocked; const btn = document.getElementById('btn-lock-layout'); const h = document.querySelector('.resizer-h'); if(window.isLayoutLocked) { btn.innerHTML = '<i class="fa-solid fa-lock"></i>'; btn.className = "btn btn-sm btn-warning"; h.classList.add('resizer-locked'); } else { btn.innerHTML = '<i class="fa-solid fa-lock-open"></i>'; btn.className = "btn btn-sm btn-outline-warning"; h.classList.remove('resizer-locked'); } };
        const resizerH = document.querySelector('.resizer-h'); const panelTicket = document.querySelector('.panel-ticket'); let isResizingH = false; const startH = (e) => { if(window.isLayoutLocked) return; isResizingH = true; e.preventDefault(); }; resizerH.addEventListener('mousedown', startH); resizerH.addEventListener('touchstart', startH, {passive: false}); const handleMove = (e) => { if(!isResizingH) return; const clientX = e.clientX || (e.touches && e.touches[0].clientX); if(isResizingH && clientX) { e.preventDefault(); const newWidth = window.innerWidth - clientX; if(newWidth > 200 && newWidth < window.innerWidth - 100) panelTicket.style.width = newWidth + 'px'; } }; const handleEnd = () => { isResizingH = false; }; document.addEventListener('mousemove', handleMove); document.addEventListener('touchmove', handleMove, {passive: false}); document.addEventListener('mouseup', handleEnd); document.addEventListener('touchend', handleEnd);
        const keypad = document.getElementById("floating-keypad"); const header = document.getElementById("keypad-header"); const resizerKey = document.getElementById("resize-handle"); const savedPos = JSON.parse(localStorage.getItem("posTeclado")); if (savedPos && window.innerWidth > 768) { keypad.style.left = savedPos.left; keypad.style.top = savedPos.top; keypad.style.width = savedPos.width; keypad.style.height = savedPos.height; } let isDragK = false, startXK, startYK, initLeftK, initTopK; const startDragK = (e) => { if(window.innerWidth <= 768) return; isDragK = true; startXK = e.clientX || e.touches[0].clientX; startYK = e.clientY || e.touches[0].clientY; const rect = keypad.getBoundingClientRect(); initLeftK = rect.left; initTopK = rect.top; e.preventDefault(); }; const moveDragK = (e) => { if(!isDragK) return; e.preventDefault(); const cx = e.clientX || e.touches[0].clientX; const cy = e.clientY || e.touches[0].clientY; keypad.style.left = (initLeftK + cx - startXK) + 'px'; keypad.style.top = (initTopK + cy - startYK) + 'px'; keypad.style.right = 'auto'; keypad.style.bottom = 'auto'; }; let isResizeK = false, startWK, startHK; const startResizeK = (e) => { if(window.innerWidth <= 768) return; isResizeK = true; startXK = e.clientX || e.touches[0].clientX; startYK = e.clientY || e.touches[0].clientY; startWK = parseInt(getComputedStyle(keypad).width); startHK = parseInt(getComputedStyle(keypad).height); e.stopPropagation(); e.preventDefault(); }; const moveResizeK = (e) => { if(!isResizeK) return; e.preventDefault(); const cx = e.clientX || e.touches[0].clientX; const cy = e.clientY || e.touches[0].clientY; keypad.style.width = (startWK + cx - startXK) + 'px'; keypad.style.height = (startHK + cy - startYK) + 'px'; }; const stopAllK = () => { if(isDragK || isResizeK) { localStorage.setItem("posTeclado", JSON.stringify({ left: keypad.style.left, top: keypad.style.top, width: keypad.style.width, height: keypad.style.height })); } isDragK = false; isResizeK = false; }; header.addEventListener('mousedown', startDragK); header.addEventListener('touchstart', startDragK, {passive:false}); resizerKey.addEventListener('mousedown', startResizeK); resizerKey.addEventListener('touchstart', startResizeK, {passive:false}); document.addEventListener('mousemove', (e) => { moveDragK(e); moveResizeK(e); }); document.addEventListener('touchmove', (e) => { moveDragK(e); moveResizeK(e); }, {passive:false}); document.addEventListener('mouseup', stopAllK); document.addEventListener('touchend', stopAllK);

        window.renderizarPOS = () => { const grid = document.getElementById('grid-productos-pos'); if(!grid) return; grid.innerHTML = ''; window.productos.forEach(p => { const itemEnCarrito = window.carrito.find(i => i.id === p.id); const badgeHTML = itemEnCarrito ? `<div class="qty-badge">${itemEnCarrito.cantidad}</div>` : ''; grid.innerHTML += `<button class="btn-producto" style="background-color:${p.color};color:${window.getContrastYIQ(p.color)}" onclick="agregar('${p.id}')">${badgeHTML}<span class="small text-uppercase opacity-75">${p.nombre}</span><span class="fs-4 mb-0">$${p.precio}</span></button>`; }); }; window.agregar = (id) => { const p = window.productos.find(x => x.id === id); const i = window.carrito.find(x => x.id === id); if(i) i.cantidad++; else window.carrito.push({...p, cantidad:1}); window.actualizarTicket(); }; window.modCant = (idx, n) => { window.carrito[idx].cantidad += n; if(window.carrito[idx].cantidad <= 0) window.carrito.splice(idx, 1); window.actualizarTicket(); }; window.limpiarTicket = () => { if(window.carrito.length > 0 && confirm('¿Borrar todo?')) { window.carrito = []; window.montoRecibido = ""; window.actualizarTicket(); } else { window.montoRecibido = ""; window.actualizarTicket(); } }; window.actualizarTicket = () => { window.renderizarPOS(); const lista = document.getElementById('ticket-lista'); if(!lista) return; lista.innerHTML = ''; let total = 0, count = 0; window.carrito.forEach((item, idx) => { total += item.precio * item.cantidad; count += item.cantidad; lista.innerHTML += `<div class="d-flex justify-content-between align-items-center border-bottom py-2 px-2" style="font-size:0.9rem"><div style="width:40%"><div class="fw-bold text-truncate">${item.nombre}</div><small class="text-muted">$${item.precio}</small></div><div class="bg-light rounded border"><button class="btn btn-sm btn-ajuste text-danger fw-bold" onclick="modCant(${idx},-1)">-</button><span class="mx-2 fw-bold">${item.cantidad}</span><button class="btn btn-sm btn-ajuste text-success fw-bold" onclick="modCant(${idx},1)">+</button></div><div class="fw-bold text-end" style="width:20%">$${item.precio*item.cantidad}</div></div>`; }); document.getElementById('items-count').innerText = count; document.getElementById('txt-total').innerText = '$' + total; document.getElementById('keypad-total-info').innerText = 'Total: $' + total; const badgeMobile = document.getElementById('tab-total-badge'); if(badgeMobile) badgeMobile.innerText = '$' + total; const rec = parseInt(window.montoRecibido || 0); const lblRec = window.montoRecibido ? '$' + rec : '-'; document.getElementById('txt-recibido-main').innerText = 'Recibido: ' + lblRec; document.getElementById('keypad-input').innerText = lblRec; let lblCambio = "$0"; let claseColor = "text-secondary"; if (window.montoRecibido) { if (rec < total) { lblCambio = "FALTA $" + (total - rec); claseColor = "text-danger fw-bold"; } else { lblCambio = "$" + (rec - total); claseColor = "text-success fw-bold"; } } document.getElementById('txt-cambio-main').innerText = 'Cambio: ' + lblCambio; const elKey = document.getElementById('keypad-cambio-info'); elKey.innerText = 'Cambio: ' + lblCambio; elKey.className = claseColor; }; window.teclado = (n) => { window.montoRecibido += n; window.actualizarTicket(); }; window.borrarInput = () => { window.montoRecibido = ""; window.actualizarTicket(); }; window.cobrar = async () => { const total = window.carrito.reduce((s, i) => s + (i.precio * i.cantidad), 0); if(total === 0) return; let pago = parseInt(window.montoRecibido || total); if(window.montoRecibido && pago < total) return alert("Pago insuficiente"); try { await addDoc(collection(db, "ventas"), { fecha: new Date().toISOString(), items: window.carrito, total: total, pago: pago, vendedor: window.currentRole }); window.carrito = []; window.montoRecibido = ""; window.actualizarTicket(); const b = document.querySelector('#btn-cobrar-key'); const o = b.innerHTML; b.innerHTML = '¡GUARDADO!'; setTimeout(() => b.innerHTML = o, 1000); } catch (e) { alert("Error: " + e.message); } };
        window.cargarTablaProductos = () => { const b = document.getElementById('tabla-productos-body'); if(!b) return; b.innerHTML = ''; window.productos.forEach(p => { b.innerHTML += `<tr data-id="${p.id}"><td class="handle-drag"><i class="fa-solid fa-grip-vertical"></i></td><td><div style="width:25px;height:25px;background:${p.color};border-radius:50%"></div></td><td>${p.nombre}</td><td>$${p.precio}</td><td class="text-end"><button class="btn btn-sm btn-light border me-1" onclick="editarProd('${p.id}')"><i class="fa-solid fa-pen"></i></button><button class="btn btn-sm btn-outline-danger border" onclick="eliminarProductoDirecto('${p.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); if(b.sortableInstance) b.sortableInstance.destroy(); b.sortableInstance = new Sortable(b, { handle: '.handle-drag', animation: 150, onEnd: function() { actualizarOrdenProductos(); } }); }; async function actualizarOrdenProductos() { const rows = document.querySelectorAll('#tabla-productos-body tr'); const batch = writeBatch(db); rows.forEach((row, index) => { const id = row.getAttribute('data-id'); const ref = doc(db, "productos", id); batch.update(ref, { orden: index }); }); try { await batch.commit(); } catch(e) { console.error(e); } } window.eliminarProductoDirecto = async (id) => { if(confirm('¿Borrar producto?')) { try { await deleteDoc(doc(db, "productos", id)); } catch(e) { alert(e.message); } } }; window.abrirModalProducto = () => { window.editId = null; document.getElementById('prod-nombre').value = ''; document.getElementById('prod-precio').value = ''; document.getElementById('prod-color').value = '#2ecc71'; document.getElementById('btn-del-prod').style.display = 'none'; modal.show(); }; window.editarProd = (id) => { const p = window.productos.find(x => x.id === id); window.editId = id; document.getElementById('prod-nombre').value = p.nombre; document.getElementById('prod-precio').value = p.precio; document.getElementById('prod-color').value = p.color; document.getElementById('btn-del-prod').style.display = 'block'; modal.show(); }; window.guardarProducto = async () => { const n = document.getElementById('prod-nombre').value; const pr = parseFloat(document.getElementById('prod-precio').value); const c = document.getElementById('prod-color').value; if(!n || !pr) return; try { if(window.editId) await updateDoc(doc(db, "productos", window.editId), { nombre:n, precio:pr, color:c }); else { const total = window.productos.length; await addDoc(collection(db, "productos"), { nombre:n, precio:pr, color:c, orden: total }); } modal.hide(); } catch (e) { alert("Error: " + e.message); } }; window.eliminarProducto = async () => { if(confirm('¿Eliminar?')) { try { await deleteDoc(doc(db, "productos", window.editId)); modal.hide(); } catch(e) { alert(e.message); } } }; const modal = new bootstrap.Modal(document.getElementById('modalProducto')); window.cargarVentasEspecificas = () => { const fechaInput = document.getElementById('filtro-dia-especifico').value; if(!fechaInput) return; const ventasDia = window.ventas.filter(v => window.fechaLocalCorta(v.fecha) === fechaInput); document.getElementById('contenido-especifico').style.display = 'block'; const totalDinero = ventasDia.reduce((sum, v) => sum + (v.total || 0), 0); document.getElementById('total-dia-esp').innerText = '$' + totalDinero; document.getElementById('titulo-dia-esp').innerText = 'Resumen: ' + new Date(fechaInput + 'T12:00:00').toLocaleDateString(); const ctx = document.getElementById('graficoEspecifico'); const labels = ["12pm","1pm","2pm","3pm","4pm","5pm","6pm","7pm","8pm","9pm","10pm","11pm"]; const data = Array(12).fill(0); ventasDia.forEach(v => { const h = new Date(v.fecha).getHours(); if(h >= 12) { const idx = h - 12; if(idx < 12) data[idx] += (v.total || 0); } }); if(window.chartEsp) window.chartEsp.destroy(); window.chartEsp = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Venta ($)', data: data, backgroundColor: '#198754', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); const resumenProductos = {}; ventasDia.forEach(v => { (v.items || []).forEach(item => { const n = item.nombre || "Desc"; if(!resumenProductos[n]) resumenProductos[n] = { cant: 0, total: 0 }; resumenProductos[n].cant += (item.cantidad || 0); resumenProductos[n].total += (item.precio * item.cantidad); }); }); const ranking = Object.keys(resumenProductos).map(key => ({ nombre: key, ...resumenProductos[key] })).sort((a, b) => b.cant - a.cant); const tbody = document.getElementById('tabla-productos-esp'); tbody.innerHTML = ''; if(ranking.length === 0) tbody.innerHTML = '<tr><td colspan="3" class="text-center">Sin ventas</td></tr>'; else ranking.forEach(p => { tbody.innerHTML += `<tr><td>${p.nombre}</td><td class="text-center fw-bold">${p.cant}</td><td class="text-end text-success">$${p.total}</td></tr>`; }); }; 
        
        // --- FUNCIONES RESTAURADAS PARA HISTORIAL/REPORTES (CORRECTAS) ---
        window.eliminarTicket = async (idVenta) => { if(confirm("¿Eliminar ticket?")) try { await deleteDoc(doc(db, "ventas", idVenta)); } catch(e){alert(e.message);} };
        window.toggleDetalle = (id) => { const el = document.getElementById(id); if(el) el.classList.toggle('fila-activa'); };
        window.toggleCollapse = (id) => { const el = document.getElementById(id); if(el) el.classList.toggle('show'); };
        window.modificarVentaPasada = async (idVenta, idxItem, cambio) => { const venta = window.ventas.find(v => v.id === idVenta); if(!venta) return; const nuevosItems = [...venta.items]; const item = nuevosItems[idxItem]; item.cantidad += cambio; if(item.cantidad <= 0) nuevosItems.splice(idxItem, 1); try { if(nuevosItems.length === 0) await deleteDoc(doc(db, "ventas", idVenta)); else { const nuevoTotal = nuevosItems.reduce((sum, i) => sum + (i.precio * i.cantidad), 0); await updateDoc(doc(db, "ventas", idVenta), { items: nuevosItems, total: nuevoTotal }); } } catch(e) { alert(e.message); } };
        
        function generarHTMLTickets(listaVentas, prefijoId) {
            if(!listaVentas || listaVentas.length === 0) return '<tr><td colspan="3" class="text-center text-muted p-3">Sin ventas</td></tr>';
            let html = '';
            const listaOrdenada = listaVentas.sort((a,b) => new Date(a.fecha) - new Date(b.fecha)).reverse();
            
            listaOrdenada.forEach(v => {
                const fechaObj = new Date(v.fecha);
                const hora = fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const idFila = prefijoId + '-' + v.id;
                const itemsSafe = v.items || [];
                const resumen = itemsSafe.length > 0 ? itemsSafe.map(i => (i.cantidad || 0) + 'x ' + (i.nombre || '???')).join(', ') : '<span class="text-danger">Datos antiguos</span>';
                
                const btnEliminar = window.currentRole === 'admin' 
                    ? `<button class="btn btn-outline-danger btn-sm ms-3 py-0 px-2" onclick="event.stopPropagation(); eliminarTicket('${v.id}')"><i class="fa-solid fa-trash"></i></button>`
                    : '';

                html += `<tr class="cursor-pointer bg-white border-bottom" onclick="toggleDetalle('${idFila}')"><td class="fw-bold text-secondary" style="width:20%">${hora}</td><td class="small text-muted text-truncate" style="max-width:150px">${resumen}</td><td class="fw-bold text-end d-flex justify-content-end align-items-center"><span>$${(v.total||0)}</span>${btnEliminar}</td></tr>`;
                html += `<tr id="${idFila}" class="fila-detalle"><td colspan="3" class="p-0 bg-light"><div class="p-3 border-bottom"><p class="small fw-bold mb-2 text-primary">Editar Productos:</p>`;
                
                if(window.currentRole === 'admin') {
                    if(itemsSafe.length > 0) {
                        html += '<ul class="list-group">';
                        itemsSafe.forEach((item, idxItem) => {
                            html += `<li class="list-group-item d-flex justify-content-between align-items-center p-2">
                                <span>${(item.nombre||"?")} <small class="text-muted">($${(item.precio||0)})</small></span>
                                <div>
                                    <button class="btn btn-outline-danger btn-sm py-0 px-2 me-2" onclick="modificarVentaPasada('${v.id}', ${idxItem}, -1)">-</button>
                                    <span class="fw-bold">${(item.cantidad||0)}</span>
                                    <button class="btn btn-outline-success btn-sm py-0 px-2 ms-2" onclick="modificarVentaPasada('${v.id}', ${idxItem}, 1)">+</button>
                                </div>
                            </li>`;
                        });
                        html += '</ul>';
                    } else { html += '<p class="text-muted small">Ticket no editable.</p>'; }
                } else {
                    html += '<p class="text-muted small fst-italic">Solo Admin puede editar ventas pasadas.</p>';
                }
                html += '</div></td></tr>';
            });
            return html;
        }

        window.cargarReporteDiario = () => { const hoyStr = window.fechaLocalCorta(new Date().toISOString()); const ventasHoy = window.ventas.filter(v => window.fechaLocalCorta(v.fecha) === hoyStr); const total = ventasHoy.reduce((sum, v) => sum + (v.total || 0), 0); document.getElementById('reporte-total-hoy').innerText = '$' + total; document.getElementById('reporte-conteo-hoy').innerText = ventasHoy.length; document.getElementById('tbody-ventas-hoy').innerHTML = generarHTMLTickets(ventasHoy, 'dia'); generarGraficaHoras(ventasHoy); };
        
        window.cargarReporteGeneral = () => {
            const ini = document.getElementById('filtro-inicio').value;
            const fin = document.getElementById('filtro-fin').value;
            const div = document.getElementById('contenedor-historial');
            if(!ini || !fin) return;
            const filtradas = window.ventas.filter(v => { const f = window.fechaLocalCorta(v.fecha); return f >= ini && f <= fin; });
            if(filtradas.length === 0) { div.innerHTML = '<div class="alert alert-light text-center border">No hay ventas.</div>'; return; }
            const grupos = {};
            filtradas.forEach(v => { const dia = window.fechaLocalCorta(v.fecha); if(!grupos[dia]) grupos[dia] = []; grupos[dia].push(v); });
            let html = '<div class="accordion">';
            Object.keys(grupos).sort().reverse().forEach(dia => {
                const lista = grupos[dia];
                const totalDia = lista.reduce((s, v) => s + (v.total || 0), 0);
                const fechaTexto = new Date(dia + 'T12:00:00').toLocaleDateString('es-ES', {weekday:'short', day:'numeric', month:'short'});
                const idCollapse = 'collapse-' + dia;
                html += `<div class="card mb-2 border-0 shadow-sm"><div class="card-header bg-white d-flex justify-content-between align-items-center py-3 cursor-pointer dia-header" onclick="toggleCollapse('${idCollapse}')"><div><h6 class="mb-0 fw-bold text-uppercase">${fechaTexto}</h6><small class="text-muted">${lista.length} tickets</small></div><h5 class="mb-0 fw-bold text-success">$${totalDia}</h5></div><div id="${idCollapse}" class="collapse"><div class="card-body p-0"><table class="table mb-0"><tbody class="bg-light">${generarHTMLTickets(lista, 'gen-'+dia)}</tbody></table></div></div></div>`;
            });
            html += '</div>';
            div.innerHTML = html;
        };

        function generarGraficaHoras(datos) { const ctx = document.getElementById('graficoDia'); const labels = ["12pm","1pm","2pm","3pm","4pm","5pm","6pm","7pm","8pm","9pm","10pm","11pm"]; const data = Array(12).fill(0); datos.forEach(v => { const h = new Date(v.fecha).getHours(); if(h >= 12) { const idx = h - 12; if(idx < 12) data[idx] += (v.total || 0); } }); if(window.chartDia) window.chartDia.destroy(); window.chartDia = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Venta ($)', data: data, backgroundColor: '#0d6efd', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); }
        window.descargarExcel = () => { const ini = document.getElementById('exp-inicio').value; const fin = document.getElementById('exp-fin').value; if(!ini || !fin) return alert("Selecciona fechas"); const rep = window.ventas.filter(v => { const f = window.fechaLocalCorta(v.fecha); return f >= ini && f <= fin; }); if(rep.length === 0) return alert("Sin datos"); const filas = []; rep.forEach(v => { const itemsSafe = v.items || []; const fechaLocal = new Date(v.fecha).toLocaleDateString(); const horaLocal = new Date(v.fecha).toLocaleTimeString(); const vendedor = v.vendedor ? (v.vendedor === 'admin' ? 'Admin' : 'Empleado') : 'N/A'; if(itemsSafe.length === 0) { filas.push({ "ID": v.id, "Fecha": fechaLocal, "Hora": horaLocal, "Vendedor": vendedor, "Prod": "BORRADO", "Total": 0 }); } else { itemsSafe.forEach(i => { filas.push({ "ID": v.id, "Fecha": fechaLocal, "Hora": horaLocal, "Vendedor": vendedor, "Prod": i.nombre, "Precio": i.precio, "Cant": i.cantidad, "Total": i.precio*i.cantidad }); }); } }); const ws = XLSX.utils.json_to_sheet(filas); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Ventas"); XLSX.writeFile(wb, `Ventas_${ini}_${fin}.xlsx`); };
        const hoy = window.fechaLocalCorta(new Date().toISOString()); document.querySelectorAll('input[type="date"]').forEach(i => i.value = hoy);
    </script>
</body>
</html>


